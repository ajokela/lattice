name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  build-and-test:
    name: Build & Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y libedit-dev libssl-dev libsqlite3-dev

      - name: Build
        run: make

      - name: Build extensions
        run: |
          make ext-sqlite
          make ext-ffi

      - name: Test
        run: make test

  extensions:
    name: Extension Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y libedit-dev libssl-dev libsqlite3-dev

      - name: Build Lattice
        run: make

      - name: Build SQLite extension
        run: make ext-sqlite

      - name: Build FFI extension
        run: make ext-ffi

      - name: Build remaining extensions (compile check)
        run: |
          make ext-redis
          make ext-image

      - name: Build WebSocket extension
        run: |
          if [ "$RUNNER_OS" = "macOS" ]; then
            export PKG_CONFIG_PATH="$(brew --prefix openssl@3)/lib/pkgconfig${PKG_CONFIG_PATH:+:$PKG_CONFIG_PATH}"
          fi
          make ext-websocket

      - name: Test SQLite extension
        run: ./clat tests/ext_sqlite_test.lat

      - name: Test FFI extension
        run: ./clat tests/ext_ffi_test.lat

  gcc-werror:
    name: GCC -Werror
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y libedit-dev libssl-dev libsqlite3-dev

      - name: Build with GCC -Werror
        run: make CC=gcc

      - name: Build extensions
        run: |
          make ext-sqlite
          make ext-ffi CC=gcc

      - name: Test
        run: make test

  asan:
    name: AddressSanitizer + UBSan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y libedit-dev libssl-dev libsqlite3-dev

      - name: Build extensions
        run: |
          make ext-sqlite
          make ext-ffi

      - name: ASan + UBSan (all backends)
        run: ulimit -s 32768 && make asan-all
        env:
          ASAN_OPTIONS: detect_leaks=0

  tsan:
    name: ThreadSanitizer
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y libedit-dev libssl-dev libsqlite3-dev

      - name: Build extensions
        run: |
          make ext-sqlite
          make ext-ffi

      - name: TSan
        run: make tsan

  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y libedit-dev libssl-dev clang-tools

      - name: Analyze
        run: make analyze

  clang-tidy:
    name: clang-tidy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y libedit-dev libssl-dev clang-tidy

      - name: Run clang-tidy
        run: make clang-tidy

  heaptrack:
    name: Heap Profiling
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y libedit-dev libssl-dev heaptrack

      - name: Build (debug)
        run: make CFLAGS="-std=c11 -Wall -Wextra -Iinclude -g -O1 -DVM_USE_COMPUTED_GOTO -I/usr/include/editline -DLATTICE_HAS_EDITLINE -DLATTICE_HAS_TLS -D_DEFAULT_SOURCE"

      - name: Profile test suite
        run: |
          make build/test_runner
          heaptrack ./build/test_runner 2>&1 | tee heaptrack_output.txt || true

      - name: Analyze results
        run: |
          # Find the heaptrack data file
          HT_FILE=$(ls -t heaptrack.test_runner.*.zst 2>/dev/null | head -1)
          if [ -z "$HT_FILE" ]; then
            HT_FILE=$(ls -t heaptrack.test_runner.*.gz 2>/dev/null | head -1)
          fi
          if [ -n "$HT_FILE" ]; then
            heaptrack_print "$HT_FILE" | tee heaptrack_analysis.txt
            echo ""
            echo "=== Summary ==="
            grep -E "peak heap|total allocations|leaked" heaptrack_analysis.txt || true
          else
            echo "Heaptrack summary from inline output:"
            grep -E "peak heap|allocations|leaked|temporary" heaptrack_output.txt || true
          fi

      - name: Upload heaptrack data
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: heaptrack-data
          path: |
            heaptrack.test_runner.*
            heaptrack_analysis.txt
            heaptrack_output.txt
          retention-days: 14

  wasm:
    name: WASM
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: 'latest'

      - name: Build WASM
        run: |
          mkdir -p build
          make wasm WASM_OUT=build/lattice.js

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run WASM smoke tests
        run: node tests/wasm_smoke_test.js

  fuzz:
    name: Fuzz (60s smoke test)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y libedit-dev libssl-dev clang llvm

      - name: Build all fuzzers
        run: make fuzz-all FUZZ_CC=clang

      - name: Seed corpus
        run: make fuzz-seed

      - name: Run tree-walk fuzzer (60s)
        run: |
          # Run fuzzer; stack-overflow crashes from deeply nested input are
          # expected for a recursive-descent evaluator â€” filter them out.
          ./build/fuzz_eval fuzz/corpus/ -max_len=4096 -max_total_time=60 || true
          # Fail only if crash artifacts exist that are NOT stack overflows
          has_real_crash=0
          for f in crash-* leak-* timeout-*; do
            [ -e "$f" ] || continue
            # Reproduce to check if it's a stack overflow
            output=$(./build/fuzz_eval "$f" 2>&1 || true)
            if echo "$output" | grep -q "stack-overflow"; then
              echo "Ignoring stack-overflow crash: $f"
              rm "$f"
            else
              echo "Real crash found: $f"
              echo "$output"
              has_real_crash=1
            fi
          done
          exit $has_real_crash
        env:
          ASAN_OPTIONS: detect_leaks=0

      - name: Run stack VM fuzzer (60s)
        run: |
          ./build/fuzz_stackvm fuzz/corpus/ -max_len=4096 -max_total_time=60 || true
          has_real_crash=0
          for f in crash-* leak-* timeout-*; do
            [ -e "$f" ] || continue
            output=$(./build/fuzz_stackvm "$f" 2>&1 || true)
            if echo "$output" | grep -q "stack-overflow"; then
              echo "Ignoring stack-overflow crash: $f"
              rm "$f"
            else
              echo "Real crash found: $f"
              echo "$output"
              has_real_crash=1
            fi
          done
          exit $has_real_crash
        env:
          ASAN_OPTIONS: detect_leaks=0

      - name: Run RegVM fuzzer (60s)
        run: |
          ./build/fuzz_regvm fuzz/corpus/ -max_len=4096 -max_total_time=60 || true
          has_real_crash=0
          for f in crash-* leak-* timeout-*; do
            [ -e "$f" ] || continue
            output=$(./build/fuzz_regvm "$f" 2>&1 || true)
            if echo "$output" | grep -q "stack-overflow"; then
              echo "Ignoring stack-overflow crash: $f"
              rm "$f"
            else
              echo "Real crash found: $f"
              echo "$output"
              has_real_crash=1
            fi
          done
          exit $has_real_crash
        env:
          ASAN_OPTIONS: detect_leaks=0
